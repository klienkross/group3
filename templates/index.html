<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM 安全审计</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .btn { padding: 10px 16px; background: #3b82f6; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px; }
    .btn:disabled { background: #9cbcf9; cursor: not-allowed; }
    .btn.secondary { background: #10b981; }
    .btn.secondary:disabled { background: #6ee7b7; }
    .controls { margin: 16px 0; }
    .card { border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f8f8f8; }
    .stat { display: inline-block; margin-right: 16px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <h1>LLM 安全审计演示</h1>
  
  <div class="controls">
    <h3>选择分析模式：</h3>
    <button id="llmBtn" class="btn">运行 LLM 审计</button>
    <button id="codeqlBtn" class="btn secondary">运行 CodeQL 分析</button>
    <br/>
    <span id="status" style="margin-left:12px;"></span>
  </div>

  <div id="results" class="card" style="display:none;">
    <h2>统计结果</h2>
    <div id="stats"></div>
    <h3>结果预览（前5条）</h3>
    <table id="previewTable">
      <thead>
        <tr>
          <th>tcName</th>
          <th>URL</th>
          <th>ground_truth</th>
          <th>llm_prediction</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const llmBtn = document.getElementById('llmBtn');
    const codeqlBtn = document.getElementById('codeqlBtn');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const statsEl = document.getElementById('stats');
    const tbody = document.querySelector('#previewTable tbody');

    async function runAnalysis(endpoint) {
      llmBtn.disabled = true;
      codeqlBtn.disabled = true;
      resultsEl.style.display = 'none';
      statsEl.innerHTML = '';
      tbody.innerHTML = '';

      // 开始轮询进度
      let pollId = setInterval(async () => {
        try {
          const r = await fetch('/progress');
          const d = await r.json();
          statusEl.textContent = d.msg || '处理中…';
        } catch (_) {}
      }, 800);

      try {
        const resp = await fetch(endpoint, { method: 'POST' });
        const data = await resp.json();
        
        if (!data.ok) {
          statusEl.textContent = '出错：' + (data.error || '未知错误');
          return;
        }

        // 渲染统计
        const s = data.stats || data.comparison || {};
        const pct = (x) => typeof x === 'number' ? (x * 100).toFixed(2) + '%' : '-';
        
        let statsHtml = '';
        if (s.total_samples !== undefined && s.accuracy !== undefined) {
          // LLM 模式
          statsHtml = `
            <div class="stat">总样本数: <b>${s.total_samples ?? '-'}</b></div>
            <div class="stat">有效预测: <b>${s.valid_predictions ?? '-'}</b></div>
            <div class="stat">准确率: <b>${pct(s.accuracy)}</b></div>
            <div class="stat">Precision: <b>${pct(s.precision)}</b></div>
            <div class="stat">Recall: <b>${pct(s.recall)}</b></div>
            <div class="stat">F1: <b>${pct(s.f1_score)}</b></div>
          `;
        } else if (s.codeql_findings !== undefined) {
          // CodeQL 模式
          statsHtml = `
            <div class="stat">LLM 检测: <b>${s.llm_detections ?? '-'}</b></div>
            <div class="stat">CodeQL 检测: <b>${s.codeql_findings ?? '-'}</b></div>
            <div class="stat">样本总数: <b>${s.total_samples ?? '-'}</b></div>
          `;
        }
        statsEl.innerHTML = statsHtml;

        // 渲染预览
        (data.preview || []).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.tcName ?? ''}</td>
            <td>${r.URL ?? ''}</td>
            <td>${r.ground_truth ?? ''}</td>
            <td>${r.llm_prediction ?? ''}</td>
          `;
          tbody.appendChild(tr);
        });

        resultsEl.style.display = 'block';
        statusEl.textContent = '完成';
      } catch (err) {
        console.error(err);
        statusEl.textContent = '出错：' + err.message;
      } finally {
        clearInterval(pollId);
        llmBtn.disabled = false;
        codeqlBtn.disabled = false;
      }
    }

    llmBtn.addEventListener('click', () => runAnalysis('/run'));
    codeqlBtn.addEventListener('click', () => runAnalysis('/codeql'));
  </script>
</body>
</html>
